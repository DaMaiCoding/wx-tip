# 微信消息防撤回功能技术方案

## 1. 概述
本方案旨在通过非注入式手段（UI Automation）实现微信消息的防撤回功能。核心策略是建立“本地历史镜像”并结合“侧边栏监控”与“焦点触发校验”，以解决传统侧边栏监控无法检测历史消息撤回的痛点。

## 2. 核心机制：影子信箱 (Shadow Inbox)

系统不再仅比对“当前”与“上一次”的瞬时状态，而是为每个会话维护一个**持久化的滚动消息队列**。

### 2.1 数据结构
在 `monitor.ps1` 中维护一个全局字典 `Dictionary<string, List<Message>>`：

```powershell
$ShadowInbox = @{
    "文件传输助手" = @(
        @{ time = "10:01"; content = "方案A初稿"; type = "text" },
        @{ time = "10:02"; content = "方案B修改版"; type = "file" }
    )
    "产品经理" = @(
        @{ time = "11:00"; content = "下周上线"; type = "text" }
    )
}
```

### 2.2 消息录入逻辑
1.  **持续扫描**：`monitor.ps1` 的主循环持续扫描侧边栏。
2.  **增量追加**：当检测到某会话的最后一条消息内容（`LastMessage`）与该会话队列中的**最新一条**不一致，且该内容不是“撤回提示”时，将其追加到队列末尾。
3.  **队列管理**：为防止内存溢出，每个会话仅保留最近 20-50 条记录。

## 3. 撤回检测逻辑

采用分级检测策略，覆盖“最新撤回”和“历史撤回”两种场景。

### 3.1 场景一：最新消息撤回 (实时)
*   **场景描述**：对方发送消息 B，侧边栏显示 B，紧接着对方撤回 B，侧边栏显示“"xxx" 撤回了一条消息”。
*   **触发条件**：侧边栏文本突变为撤回关键词。
*   **处理流程**：
    1.  检测到侧边栏变为撤回提示。
    2.  读取 `ShadowInbox` 中该会话的**最后一条记录**。
    3.  立即触发报警：“检测到撤回：[内容]”。

### 3.2 场景二：历史消息撤回 (延迟/按需)
*   **场景描述**：对方发送 A，然后发送 B。侧边栏显示 B。此时对方撤回 A。侧边栏依然显示 B，无变化。
*   **触发条件**：**焦点触发校验 (Focus-Triggered Check)**。
    *   当检测到微信窗口从“后台”切换到“前台”（Active Window 变为微信）。
    *   或者用户点击了某个侧边栏项目（进入聊天详情）。
*   **处理流程**：
    1.  **触发扫描**：利用 UI Automation 快速扫描当前聊天窗口可视区域（Message List）。
    2.  **特征寻找**：查找屏幕上是否存在系统灰字提示（如“"xxx" 撤回了一条消息”）。
    3.  **上下文定位**：
        *   获取该提示**下一条**正常消息的内容（例如 B）。
        *   在 `ShadowInbox` 中定位消息 B。
        *   回溯 B 的**前一条**消息（即 A）。
    4.  **结果展示**：弹窗提示“检测到历史撤回：[A的内容]”。

## 4. 实施路线图

### 第一阶段：基础架构改造
1.  **状态升级**：将 `monitor.ps1` 中的 `$global:lastState` (Hashtable) 升级为 `$global:ShadowInbox` (Complex Object)。
2.  **消息指纹**：为每条消息生成唯一指纹（Hash: Time + Content），以便精确比对。

### 第二阶段：双循环机制
1.  **Loop A (高频)**：维持现有的侧边栏扫描（100ms/次），负责录入新消息和检测最新撤回。
2.  **Event B (触发)**：引入 `AutomationEventHandler` 或在主循环中检测 `GetForegroundWindow` 变化，触发可视区域深度扫描。

### 第三阶段：交互优化
1.  **通知聚合**：避免短时间内连续撤回造成通知轰炸。
2.  **撤回历史查看**：在 Electron 前端增加一个“撤回历史”页面，持久化保存所有被撤回的消息。

## 5. 优缺点评估

| 维度 | 评价 | 说明 |
| :--- | :--- | :--- |
| **覆盖率** | 高 | 解决了侧边栏监控的盲区，覆盖历史撤回。 |
| **性能** | 中 | 只有在用户激活窗口时才进行深度扫描，平时保持低功耗。 |
| **体验** | 优 | 符合用户心理模型：不看时不打扰，一看就知道刚才错过了什么。 |
| **风险** | 低 | 依然基于 UI Automation，不注入进程，封号风险极低。 |
